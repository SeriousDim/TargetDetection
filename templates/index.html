<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ –º–∏—à–µ–Ω–∏</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="icon" href="/static/icons/logo_ico.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="page-wrapper">
        <!-- Header -->
        <header class="header">
            <div class="container d-flex justify-content-center">   
            <!-- <div class="container d-flex align-items-center justify-content-between"> -->
                <!-- <img src="/static/icons/logo_napis_png.png" alt="–õ–æ–≥–æ—Ç–∏–ø" class="logo"> -->
                <h1 class="title">–°–±–æ—Ä –∏ —Ä–∞–∑–º–µ—Ç–∫–∞ –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–∏—Ä–∞</h1>
            </div>
        </header>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="wrapper">
            <main class="container-fluid mt-5">
                <div class="row">
                    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
                    <div class="col-md-4">
                        <h3 class="section-title">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3>
                        <form id="upload-form" enctype="multipart/form-data">
                            <div class="form-group">
                                <label for="file-upload">–§–∞–π–ª:</label>
                                <input type="file" class="form-control-file" id="file-upload" name="file">
                            </div>
                            <button type="submit" class="btn btn-primary btn-block btn-custom">–ê–Ω–∞–ª–∏–∑</button>
                            <button id="clear-hits-btn" class="btn btn-primary btn-block btn-custom d-none">
                                –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ–ø–∞–¥–∞–Ω–∏—è
                            </button>
                        </form>
                    </div>

                    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å -->
                    <div class="col-md-8">
                        <h3 class="section-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h3>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th class="fixed-width">–ú–∏—à–µ–Ω—å</th>
                                    <th class="fixed-width">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø–∞–¥–∞–Ω–∏–π</th>
                                    <th class="fixed-width">–°–µ–∫—Ç–æ—Ä–∞</th>
                                    <th class="flexible-width">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="fixed-width" id="target-name">-</td>
                                    <td class="fixed-width" id="hits-count">-</td>
                                    <td class="fixed-width" id="hits-sectors">-</td>
                                    <td class="flexible-width" id="recommendation">-</td>
                                </tr>
                            </tbody>
                        </table>
                        <h4 class="section-title">–†–∞–∑–º–µ—á–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</h4>
                        <div class="image-container position-relative">
                            <span id="placeholder" class="placeholder"></span>
                            <img id="annotated-image" class="img-fluid d-none" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞">
                        </div>
                        <div class="text-center mt-3">
                            <button id="download-btn" class="btn btn-primary btn-custom d-none">
                                –°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
        <div id="clear-hits-modal" class="custom-modal">
            <div class="custom-modal-content">
                <span id="close-modal-btn" class="custom-close-btn">&times;</span>
                <p>–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ–ø–∞–¥–∞–Ω–∏—è –Ω–µ –±—É–¥—É—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–≥—Ä—É–∑–∫–∞—Ö –º–∏—à–µ–Ω–∏.</p>
            </div>
        </div>
        <!-- Footer -->
        <footer class="footer">
            <div class="container text-center">
                <p>–°–æ–ª–æ–¥–Ω–∏–∫–æ–≤–∞ –°–æ—Ñ–∏—è</p>
                <p>–õ—ã–∫–æ–≤ –î–º–∏—Ç—Ä–∏–π</p>
                <p>–ê–ª–µ–∫—Å–µ–µ–≤ –õ–µ–≤</p>
            </div>
        </footer>
    </div>

    <!-- JavaScript –±–ª–æ–∫ -->
    <script>
        const form = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-upload');
        const targetName = document.getElementById('target-name');
        const hitsCount = document.getElementById('hits-count');
        const hitsSectors = document.getElementById('hits-sectors');
        const recommendation = document.getElementById('recommendation');
        const annotatedImage = document.getElementById('annotated-image');
        const placeholder = document.getElementById('placeholder');
        const downloadBtn = document.getElementById('download-btn');
    
        const clearHitsBtn = document.getElementById('clear-hits-btn');
        const clearHitsModal = document.getElementById('clear-hits-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
    
        let isClearingHits = false;  // –§–ª–∞–≥, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—â–∏–π –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞
    
        // üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
    
            if (isClearingHits) {
                console.warn("–û—á–∏—Å—Ç–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, –∑–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.");
                return;
            }
    
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
    
            try {
                const response = await fetch('/recommendations', {
                    method: 'POST',
                    body: formData,
                });
    
                const data = await response.json();
    
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                targetName.textContent = data.target_name;
                hitsCount.textContent = data.hits_sectors.length;
                hitsSectors.textContent = data.hits_sectors.join(', ');
                recommendation.textContent = data.recommendation;
    
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–∑–º–µ—á–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                annotatedImage.src = `data:image/png;base64,${data.image}`;
                annotatedImage.classList.remove('d-none');
                placeholder.style.display = 'none';
    
                // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                downloadBtn.classList.remove('d-none');
                downloadBtn.onclick = () => {
                    const link = document.createElement('a');
                    link.href = `data:image/png;base64,${data.image}`;
                    link.download = 'annotated_image.png';
                    link.click();
                };
    
                // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ø–∞–¥–∞–Ω–∏—è", –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ø–∞–¥–∞–Ω–∏—è
                if (data.hits_sectors.length > 0) {
                    clearHitsBtn.classList.remove('d-none');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        });
    
        // üóëÔ∏è –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ–ø–∞–¥–∞–Ω–∏—è"
        clearHitsBtn.addEventListener('click', async () => {
            isClearingHits = true;  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –Ω–∞ –≤—Ä–µ–º—è –æ—á–∏—Å—Ç–∫–∏
    
            try {
                const response = await fetch('/clear_hits', {
                    method: 'POST',
                });
    
                if (response.ok) {
                    console.log("–ü–æ–ø–∞–¥–∞–Ω–∏—è –æ—á–∏—â–µ–Ω—ã");
    
                    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    clearHitsModal.style.display = 'block';
    
                    // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                    targetName.textContent = '-';
                    hitsCount.textContent = '-';
                    hitsSectors.textContent = '-';
                    recommendation.textContent = '-';
                    annotatedImage.classList.add('d-none');
                    placeholder.style.display = 'block';
                    downloadBtn.classList.add('d-none');
                    clearHitsBtn.classList.add('d-none');
    
                    // –£–±–∏—Ä–∞–µ–º —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                    setTimeout(() => {
                        isClearingHits = false;
                        location.reload();  // –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    }, 2000);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ø–æ–ø–∞–¥–∞–Ω–∏–π');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        });
    
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –Ω–∞–∂–∞—Ç–∏—é –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫
        closeModalBtn.addEventListener('click', () => {
            clearHitsModal.style.display = 'none';
        });
    
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ –æ–±–ª–∞—Å—Ç–∏
        window.addEventListener('click', (event) => {
            if (event.target === clearHitsModal) {
                clearHitsModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>
